# Airflow ETL –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø—É—Å–∫—É

–ì–∞–π–¥–ª–∞–π–Ω –ø–æ–º–æ–∂–µ—Ç –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ –≤–µ—Ç–∫–µ `alikhan_task` –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∑–∞–ø—É—Å–∫–∞ ETL.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
``` 
.
‚îú‚îÄ‚îÄ dags/
‚îÇ   ‚îî‚îÄ‚îÄ alikhan_bekkaliyev_task.py (–ù–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ —Å–∞–º –∫–æ–¥)
‚îú‚îÄ‚îÄ logs/           (Airflow —Å–∞–º —Å–æ–∑–¥–∞—Å—Ç –≤—Å–µ –ª–æ–≥–∏ –ø–æ —Ö–æ–¥—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)
‚îú‚îÄ‚îÄ plugins/        (–ü—É—Å—Ç—É–µ—Ç, –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏)
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ .env (–≤ gitignore)
‚îú‚îÄ‚îÄ .env.example (–Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π —Ç–æ–∫–µ–Ω Kaggle)
‚îú‚îÄ‚îÄ requirements.txt
‚îî‚îÄ‚îÄ README.md (—Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª)
```

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

‚Ññ1 –ê–∫–∫–∞—É–Ω—Ç Kaggle –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
‚Ññ2 Docker
‚Ññ3 Docker Compose

## Step 1: –ü–æ–ª—É—á–∏—Ç–µ id

–ß–µ—Ä–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª –∑–∞–ø–æ–ª—É—á–∏—Ç–µ id —Å –ø–æ–º–æ—â—å—é —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã:

```bash
id -u
```

## Step 2: –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env

–°–æ–∑–¥–∞–π—Ç–µ `.env` —Ñ–∞–π–ª –∏ –ø–æ –ø—Ä–∏–º–µ—Ä—É –≤ `.env.example` –∑–∞–º–µ–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ `AIRFLOW_UID` –Ω–∞ —á–∏—Å–ª–æ –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ. –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ Docker.
–í–æ–π–¥–∏—Ç–µ –≤ Kaggle. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É -> Settings -> API -> Create New Token. –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏, –∑–∞–º–µ–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è `KAGGLE_USERNAME` –∏ `KAGGLE_KEY` –Ω–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–≥—Ä—É–∑–∏–≤—à–µ–≥–æ—Å—è —Ñ–∞–π–ª–∞ (–±–µ–∑ –∫–∞–≤—ã—á–µ–∫)

## Step 3: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

–û—Ç–∫—Ä–æ–π—Ç–µ Docker Desktop –∏ –Ω–∞–ø–∏—à–∏—Ç–µ —É–∫–∞–∑–∞–Ω–Ω—É—é –Ω–∏–∂–µ –∫–æ–º–∞–Ω–¥—É –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ:

```bash
docker-compose up -d
```

–í –∏—Ç–æ–≥–µ –≤—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è Python –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è PostgreSQL –∏ Airflow.

## Step 4: –û—Ç–∫—Ä–æ–π—Ç–µ Airflow UI

–û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä –∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ URL:

**http://localhost:8080**

–í–æ–π–¥–∏—Ç–µ –≤ Airflow —Å –ø–æ–º–æ—â—å—é –¥–∞–Ω–Ω—ã—Ö —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –Ω–∏–∂–µ (–º–æ–∂–Ω–æ –∏—Ö —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤  `docker-compose.yml`):
- **Username:** `admin`
- **Password:** `admin`

## Step 5: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Postgres

–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î `postgres-etl-target` –¥–ª—è —Ä–∞–±–æ—Ç—ã –º–µ–∂–¥—É –ë–î –∏ –∫–æ–¥–æ–º.

1. –í Airflow UI, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ **Admin ‚Üí Connections**
2. –ù–∞–∂–º–∏—Ç–µ **+** —á—Ç–æ –±—ã –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
3. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è –Ω–∏–∂–µ—É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏:

   | –ü–æ–ª–µ | –ó–Ω–∞—á–µ–Ω–∏–µ | –ó–∞–º–µ—Ç–∫–∏ |
   |-------|-------|-------|
   | **Connection Id** | `postgres_etl_target_conn` | –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —á—Ç–æ –±—ã –æ–Ω–æ —Å–æ–≤–ø–∞–¥–∞–ª–æ —Å  `ETL_POSTGRES_CONN_ID` –≤–Ω—É—Ç—Ä–∏ DAG'–∞ |
   | **Connection Type** | `Postgres` | |
   | **Host** | `postgres-etl-target` | –ù–∞–∑–≤–∞–Ω–∏–µ –≤ `docker-compose.yml` |
   | **Schema** | `etl_db` | –ó–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è `postgres-etl-target` |
   | **Login** | `etl_user` | –ó–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è `postgres-etl-target` |
   | **Password** | `etl_pass` | –ó–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è `postgres-etl-target` |
   | **Port** | `5432` | –ë–∞–∑–æ–≤—ã–π –ø–æ—Ä—Ç –¥–ª—è Postgres, –µ—Å–ª–∏ —É –≤–∞—Å –∑–∞–Ω—è—Ç–æ –º–æ–∂–µ—Ç–µ –ø–æ–º–µ–Ω—è—Ç—å –Ω–∞ 5433 |

4. (–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –ù–∞–∂–º–∏—Ç–µ **Test**. –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–∞–¥–ø–∏—Å—å "Connection successfully tested."
5. –ù–∞–∂–º–∏—Ç–µ **Save**.

## Step 6: –ó–∞–ø—É—Å—Ç–∏—Ç–µ DAG

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫—É DAGs
2. –ù–∞–π–¥–∏—Ç–µ `api_to_postgres_etl` DAG
3. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É (‚ñ∂) —Å –ø—Ä–∞–≤–æ–π —Å—Ç–æ—Ä–æ–Ω—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤—Ä—É—á–Ω—É—é
4. –í –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ Airflow –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–∞–∂–¥—ã–π —Ç–∞—Å–∫ –æ—Ç–¥–µ–ª—å–Ω–æ, –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ Graph –∏ –ª–æ–≥–∏.

## Step 7: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ

–ß—Ç–æ –±—ã —É–∑–Ω–∞—Ç—å —Å—Ä–∞–±–æ—Ç–∞–ª –ª–∏ –Ω–∞—à DAG –∫–∞–∫ –Ω–∞–¥–æ –º—ã –º–æ–∂–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—é–±–æ–π –∫–ª–∏–µ–Ω—Ç SQL –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è –∫ –Ω–∞—à–µ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö `postgres-etl-target`.

- **Host:** `localhost`
- **Port:** `5433` (–•–æ—Å—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –≤ `docker-compose.yml`)
- **Database:** `etl_db`
- **User:** `etl_user`
- **Password:** `etl_pass`

–ü–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω—è–µ–º –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–ø—Ä–æ—Å:

```sql
SELECT * FROM fact_sales
ORDER BY DATE_ID
LIMIT 20;
```

–í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å —Ç–∞–±–ª–∏—Ü—É! üéâ

## –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ

–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤–≤–µ–¥–∏—Ç–µ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ, –≤—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–µ—Ä–º–∏–Ω–∞–ª —É–¥–∞–ª–∏–≤ volumes:

```bash
docker-compose down -v
```
